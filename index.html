
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>家庭教師を探す | Study Meet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #0f1c2e;
      --muted: #4c5565;
      --paper: #ffffff;
      --accent: #0ea5e9;
      --accent-2: #f97316;
      --border: #e4e9f2;
      --shadow: 0 12px 50px rgba(15, 28, 46, 0.08);
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Noto Sans JP', 'Space Grotesk', system-ui, sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at 10% 20%, rgba(14,165,233,0.08), transparent 25%),
                  radial-gradient(circle at 80% 10%, rgba(249,115,22,0.08), transparent 22%),
                  radial-gradient(circle at 20% 70%, rgba(16,185,129,0.08), transparent 22%),
                  linear-gradient(135deg, #fdf3e8 0%, #e8f6ff 55%, #f3fff5 100%);
      min-height: 100vh;
      padding: 3rem 1.5rem 4rem;
    }
    header {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2rem;
      align-items: center;
    }
    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      background: rgba(14,165,233,0.12);
      color: #055d8d;
      font-weight: 700;
      letter-spacing: 0.04em;
      font-family: 'Space Grotesk', 'Noto Sans JP', sans-serif;
      text-transform: uppercase;
      font-size: 0.8rem;
    }
    .eyebrow span {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 0 8px rgba(14,165,233,0.12);
    }
    h1 {
      font-family: 'Space Grotesk', 'Noto Sans JP', sans-serif;
      font-size: clamp(2.4rem, 4vw, 3rem);
      margin: 1rem 0 0.5rem;
      line-height: 1.2;
    }
    .lead {
      color: var(--muted);
      max-width: 560px;
      font-size: 1.05rem;
      line-height: 1.8;
    }
    .hero-card {
      background: var(--paper);
      border-radius: 18px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    .stat-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .stat {
      flex: 1 1 150px;
      background: linear-gradient(135deg, rgba(14,165,233,0.12), rgba(249,115,22,0.08));
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .stat strong {
      display: block;
      font-size: 1.4rem;
      margin-bottom: 0.2rem;
    }
    .filters {
      max-width: 1200px;
      margin: 2.5rem auto 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      align-items: center;
    }
    .filter-title {
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-family: 'Space Grotesk', 'Noto Sans JP', sans-serif;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    .chip {
      padding: 0.65rem 1rem;
      border-radius: 12px;
      background: var(--paper);
      border: 1px solid var(--border);
      color: var(--ink);
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      box-shadow: 0 6px 20px rgba(15, 28, 46, 0.05);
    }
    .chip:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
      box-shadow: 0 12px 32px rgba(14,165,233,0.15);
    }
    .chip.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 12px 32px rgba(14,165,233,0.25);
    }
    .tutors {
      max-width: 1200px;
      margin: 2rem auto 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.2rem;
    }
    .card {
      background: var(--paper);
      border-radius: 16px;
      padding: 1.25rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      display: grid;
      gap: 0.75rem;
    }
    .card.is-hidden {
      display: none;
    }
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 20px 48px rgba(15, 28, 46, 0.16);
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(14,165,233,0.15), rgba(249,115,22,0.2));
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #0b4870;
      font-family: 'Space Grotesk', 'Noto Sans JP', sans-serif;
    }
    .name {
      font-weight: 700;
      font-size: 1.1rem;
      margin: 0;
    }
    .meta {
      color: var(--muted);
      font-size: 0.95rem;
      margin: 0.1rem 0 0;
    }
    .tag-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .tag {
      background: rgba(14,165,233,0.08);
      color: #0f3750;
      padding: 0.35rem 0.65rem;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.85rem;
    }
    .tag.orange {
      background: rgba(249,115,22,0.12);
      color: #7a2d05;
    }
    .bio {
      color: var(--muted);
      line-height: 1.6;
      margin: 0;
    }
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .rating {
      font-weight: 700;
      color: #0f3750;
      display: flex;
      align-items: center;
      gap: 0.2rem;
    }
    .rating span {
      color: #f97316;
    }
    .cta-btn {
      padding: 0.7rem 1rem;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      cursor: pointer;
      box-shadow: 0 12px 24px rgba(14,165,233,0.22);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }
    .cta-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(14,165,233,0.3);
    }
    .cta-wide {
      max-width: 1200px;
      margin: 2.5rem auto 0;
      background: linear-gradient(135deg, rgba(14,165,233,0.14), rgba(249,115,22,0.14));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      align-items: center;
      box-shadow: var(--shadow);
    }
    .cta-wide strong {
      font-size: 1.3rem;
      font-family: 'Space Grotesk', 'Noto Sans JP', sans-serif;
    }
    .cta-actions {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
    }
    .ghost-btn {
      padding: 0.7rem 1rem;
      border-radius: 12px;
      border: 1px solid var(--ink);
      background: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .ghost-btn:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
      box-shadow: 0 12px 28px rgba(15, 28, 46, 0.12);
    }
    .empty {
      max-width: 1200px;
      margin: 1.5rem auto 0;
      color: var(--muted);
      background: #fff;
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      text-align: center;
      box-shadow: 0 6px 18px rgba(15, 28, 46, 0.06);
    }
    [hidden] {
      display: none !important;
    }
    footer {
      max-width: 1200px;
      margin: 2rem auto 0;
      color: var(--muted);
      font-size: 0.95rem;
      text-align: center;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 28, 46, 0.4);
      display: grid;
      place-items: center;
      padding: 1rem;
      z-index: 10;
      backdrop-filter: blur(3px);
    }
    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 1.5rem;
      width: min(520px, 100%);
      box-shadow: 0 24px 80px rgba(15, 28, 46, 0.22);
      border: 1px solid var(--border);
    }
    .modal h3 {
      margin: 0 0 0.25rem;
      font-size: 1.35rem;
    }
    .modal p {
      margin: 0 0 1rem;
      color: var(--muted);
    }
    .field {
      display: grid;
      gap: 0.4rem;
      margin-bottom: 0.9rem;
    }
    .field label {
      font-weight: 700;
      font-size: 0.95rem;
    }
    .field input,
    .field textarea {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.7rem 0.85rem;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .field input:focus,
    .field textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(14,165,233,0.18);
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.6rem;
      margin-top: 0.4rem;
    }
    .close-btn {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 0.65rem 1rem;
      cursor: pointer;
      font-weight: 700;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.15s ease;
    }
    .close-btn:hover {
      background: #f3f5f9;
      border-color: var(--accent);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="eyebrow"><span></span>家庭教師を探そう</div>
      <h1>あなたに合う先生と、マンツーマンで学びを深める</h1>
      <p class="lead">教科・レベル・目標に合わせて、経験豊富な家庭教師をマッチング。オンラインも対面も、希望のスタイルでじっくり学べます。</p>
      <div class="chips" aria-label="人気カテゴリ">
        <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="数学">数学</button>
        <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="英語">英語</button>
        <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="化学">化学</button>
        <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="小論文">小論文</button>
        <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="中学受験">中学受験</button>
        <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="プログラミング">プログラミング</button>
      </div>
    </div>
    <div class="hero-card">
      <div class="stat-row">
        <div class="stat">
          <strong>320名</strong>
          <span>登録家庭教師</span>
        </div>
        <div class="stat">
          <strong>4.9/5</strong>
          <span>平均レビュー</span>
        </div>
        <div class="stat">
          <strong>12時間</strong>
          <span>最短マッチ時間</span>
        </div>
      </div>
      <p class="lead" style="margin:0;">希望条件を伝えるだけで、最適な先生候補を3名ピックアップしてご提案します。</p>
    </div>
  </header>

  <section class="filters">
    <div class="filter-title">教科から探す</div>
    <div class="chips" id="subject-chips">
      <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="数学">数学IA/IIB</button>
      <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="英語">英語長文</button>
      <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="物理">物理</button>
      <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="化学">化学</button>
      <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="現代文">現代文</button>
      <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="TOEIC">TOEIC</button>
      <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="プログラミング">プログラミング</button>
      <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="中学受験">中学受験</button>
      <button class="chip" type="button" data-filter="subject" data-group="subject" data-value="Python">Python</button>
    </div>
  </section>

  <section class="filters" style="margin-top: 1rem;">
    <div class="filter-title">学習スタイル</div>
    <div class="chips" id="style-chips">
      <button class="chip" type="button" data-filter="style" data-group="style" data-value="オンライン">オンライン</button>
      <button class="chip" type="button" data-filter="style" data-group="style" data-value="訪問">訪問（首都圏）</button>
      <button class="chip" type="button" data-filter="style" data-group="style" data-value="スポット">スポット指導</button>
      <button class="chip" type="button" data-filter="style" data-group="style" data-value="定期テスト">定期テスト対策</button>
      <button class="chip" type="button" data-filter="style" data-group="style" data-value="受験フルサポート">受験フルサポート</button>
    </div>
  </section>

  <section class="filters" style="margin-top: 1rem; align-items: flex-start;">
    <div class="filter-title">選択中</div>
    <div>
      <div id="filter-summary" class="lead" style="margin:0; font-size:1rem;">教科: 未選択 / スタイル: 未選択</div>
      <div id="result-count" style="margin-top:0.25rem; color: var(--muted); font-weight:700;">0名がヒット</div>
    </div>
  </section>

  <section class="tutors" id="tutor-list" aria-label="家庭教師一覧"></section>
  <p id="data-status" class="empty">読み込み中です...</p>
  <p id="empty-state" class="empty" hidden>条件に合う先生が見つかりませんでした。フィルターを変更してみてください。</p>

  <section class="cta-wide">
    <strong>条件を伝えるだけで、無料で先生候補を受け取れます。</strong>
    <div class="cta-actions">
      <button class="cta-btn">無料で相談する</button>
      <a class="ghost-btn" href="https://docs.google.com/forms/d/e/1FAIpQLScRpt1CFnjgIl5Lse28QwqxNQsZ8cqk5Kis9sPZwMiENcMYwg/viewform" target="_blank" rel="noreferrer noopener">教師登録はこちらから</a>
    </div>
  </section>

  <footer>
    学校や塾と併用しながら「わかる」を増やす家庭教師サービスです。掲載希望・法人契約もお気軽にご相談ください。
  </footer>

  <div id="message-modal" class="modal-backdrop" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <h3 id="modal-title">先生にメッセージ</h3>
      <p id="modal-subtitle">先生に初回メッセージを送信できます。</p>
      <form id="message-form">
        <div class="field">
          <label for="student-name">あなたの名前</label>
          <input id="student-name" name="name" type="text" placeholder="例: 山田 太郎" required>
        </div>
        <div class="field">
          <label for="contact">連絡先メール</label>
          <input id="contact" name="contact" type="email" placeholder="email@example.com" required>
        </div>
        <div class="field">
          <label for="message">メッセージ内容</label>
          <textarea id="message" name="message" rows="4" placeholder="ご希望の教科・曜日・目標などを教えてください。" required></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="close-btn" id="modal-cancel">閉じる</button>
          <button type="submit" class="cta-btn">送信する</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbw1ERrRAGTtjkLZYOsGxeck48uCDZEwnTema4CFTokGCGqtiR46GKNjwC6pHMzKjKElbg/exec';
    const defaultTutors = [
      { name: '加藤 美咲', subjects: ['数学', '数学IA・IIB'], styles: ['オンライン', '定期テスト'], meta: '東京大学 教育学部 / 5年指導', intro: '苦手意識が強い生徒さんでも、図解と対話でじっくり理解を積み上げます。定期テスト平均＋25点の実績。', rating: '4.9', reviews: '42件' },
      { name: '佐藤 諒', subjects: ['英語長文', 'リスニング', 'TOEIC'], styles: ['オンライン', '受験フルサポート'], meta: '慶應義塾大学 法学部 / 6年指導', intro: '共通テスト〜早慶対策まで幅広く対応。音読と要約を組み合わせた「聴く＋読む」トレーニングで伸ばします。', rating: '4.8', reviews: '51件' },
      { name: '本田 真', subjects: ['物理', '化学', '難関大'], styles: ['オンライン', '受験フルサポート'], meta: '京都大学 工学部 / 4年指導', intro: '難問題を「どこで詰まるか」を言語化しながら解説。演習スケジュールの設計から添削まで伴走します。', rating: '5.0', reviews: '33件' },
      { name: '山本 航', subjects: ['現代文', '小論文'], styles: ['オンライン', 'スポット'], meta: '早稲田大学 文化構想学部 / 7年指導', intro: '文章の「型」を見える化して読み方をトレーニング。添削を重ねて書く力も養成します。帰国子女の日本語補習も可。', rating: '4.9', reviews: '48件' },
      { name: '宮田 奈々', subjects: ['中学受験', '算数', '思考力'], styles: ['訪問', 'オンライン', 'スポット'], meta: '大阪大学 基礎工学部 / 3年指導', intro: '図形・場合の数が得意。つまずきやすい単元を遊び感覚のパズルで解説し、理解を定着させます。', rating: '4.7', reviews: '29件' },
      { name: '秋山 啓太', subjects: ['プログラミング', 'Python', '情報数学'], styles: ['オンライン', '作品添削', 'スポット'], meta: '外資ITエンジニア / 5年指導', intro: '実務経験を踏まえてコードレビューも実施。競プロ・情報オリンピック対策、アプリ開発の伴走も対応します。', rating: '4.9', reviews: '37件' }
    ];

    const state = { subject: null, style: null };
    const summary = document.getElementById('filter-summary');
    const countLabel = document.getElementById('result-count');
    const emptyState = document.getElementById('empty-state');
    const dataStatus = document.getElementById('data-status');
    const tutorList = document.getElementById('tutor-list');
    const chips = Array.from(document.querySelectorAll('[data-filter]'));
    let tutors = [];

    function normalize(text) {
      return (text || '').trim().toLowerCase();
    }

    function setStatus(text, isError = false) {
      if (!dataStatus) return;
      dataStatus.hidden = !text;
      dataStatus.textContent = text || '';
      dataStatus.style.borderStyle = isError ? 'solid' : 'dashed';
    }

    function filterCards() {
      let visibleCount = 0;
      tutors.forEach(card => {
        const subjects = normalize(card.dataset.subjects);
        const styles = normalize(card.dataset.styles);
        const subjectMatch = !state.subject || subjects.includes(normalize(state.subject));
        const styleMatch = !state.style || styles.includes(normalize(state.style));
        const show = subjectMatch && styleMatch;
        card.classList.toggle('is-hidden', !show);
        if (show) visibleCount += 1;
      });
      summary.textContent = `教科: ${state.subject ?? '未選択'} / スタイル: ${state.style ?? '未選択'}`;
      countLabel.textContent = `${visibleCount}名がヒット`;
      if (emptyState) {
        emptyState.hidden = visibleCount !== 0;
      }
    }

    function pickValue(record, candidates, fallback = '') {
      for (const key of candidates) {
        if (record[key] !== undefined && String(record[key]).trim() !== '') {
          return String(record[key]).trim();
        }
      }
      return fallback;
    }

    function splitList(value) {
      return (value || '')
        .split(/[,、／/・\s]+/)
        .map(v => v.trim())
        .filter(Boolean);
    }

    function initials(name) {
      const compact = (name || '').replace(/\s+/g, '');
      return compact.slice(0, 2) || 'TT';
    }

    function mapRecord(record) {
      const name = pickValue(record, ['お名前', '名前', '氏名', 'Name'], '');
      const subjects = splitList(pickValue(record, ['教科', '担当科目', '科目', '得意科目'], ''));
      const styles = splitList(pickValue(record, ['指導形態', '学習スタイル', 'スタイル', '対応方法'], ''));
      const intro = pickValue(record, ['自己紹介', '紹介', 'メッセージ', 'PR'], '');
      const meta = pickValue(record, ['所属', '大学', '学校', '学部', '肩書き', 'プロフィール'], '');
      const rating = pickValue(record, ['評価', 'レーティング'], '');
      const reviews = pickValue(record, ['レビュー', '件数'], '');
      return {
        name,
        subjects: subjects.length ? subjects : ['教科未設定'],
        styles: styles.length ? styles : ['指導形態未設定'],
        intro: intro || '自己紹介は準備中です。',
        meta: meta || '家庭教師',
        rating: rating || '4.8',
        reviews: reviews || 'new',
        initials: initials(name)
      };
    }

    function createCard(tutor) {
      const card = document.createElement('article');
      card.className = 'card tutor-card';
      card.dataset.subjects = tutor.subjects.join(',');
      card.dataset.styles = tutor.styles.join(',');

      const header = document.createElement('div');
      header.className = 'card-header';
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = tutor.initials;
      const headerText = document.createElement('div');
      const nameEl = document.createElement('p');
      nameEl.className = 'name';
      nameEl.textContent = tutor.name;
      const metaEl = document.createElement('p');
      metaEl.className = 'meta';
      metaEl.textContent = tutor.meta;
      headerText.appendChild(nameEl);
      headerText.appendChild(metaEl);
      header.appendChild(avatar);
      header.appendChild(headerText);

      const tagRow = document.createElement('div');
      tagRow.className = 'tag-row';
      tutor.subjects.slice(0, 2).forEach(text => {
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.textContent = text;
        tagRow.appendChild(tag);
      });
      tutor.styles.slice(0, 1).forEach(text => {
        const tag = document.createElement('span');
        tag.className = 'tag orange';
        tag.textContent = text;
        tagRow.appendChild(tag);
      });

      const bio = document.createElement('p');
      bio.className = 'bio';
      bio.textContent = tutor.intro;

      const footer = document.createElement('div');
      footer.className = 'card-footer';
      const rating = document.createElement('div');
      rating.className = 'rating';
      const star = document.createElement('span');
      star.textContent = '★';
      rating.appendChild(star);
      rating.appendChild(document.createTextNode(`${tutor.rating}${tutor.reviews ? ` (${tutor.reviews})` : ''}`));
      const btn = document.createElement('button');
      btn.className = 'cta-btn message-btn';
      btn.type = 'button';
      btn.dataset.teacher = tutor.name;
      btn.textContent = 'メッセージする';
      footer.appendChild(rating);
      footer.appendChild(btn);

      card.appendChild(header);
      card.appendChild(tagRow);
      card.appendChild(bio);
      card.appendChild(footer);
      return card;
    }

    function renderTutors(list) {
      if (!tutorList) return;
      tutorList.innerHTML = '';
      const frag = document.createDocumentFragment();
      list.forEach(tutor => frag.appendChild(createCard(tutor)));
      tutorList.appendChild(frag);
      tutors = Array.from(document.querySelectorAll('.tutor-card'));
      attachMessageButtons();
      filterCards();
    }

    async function loadTutors() {
      setStatus('読み込み中です...');
      try {
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error('ステータス異常');
        const json = await res.json();
        const data = Array.isArray(json.data) ? json.data : [];
        const mapped = data.map(mapRecord).filter(t => t.name);
        if (!mapped.length) {
          setStatus('フォーム回答がまだありません。サンプルデータを表示します。');
          renderTutors(defaultTutors);
          return;
        }
        setStatus('');
        renderTutors(mapped);
      } catch (err) {
        setStatus('データ取得に失敗しました。サンプルデータを表示しています。', true);
        renderTutors(defaultTutors);
      }
    }

    // -------- フィルター ----------
    chips.forEach(chip => {
      if (chip.classList.contains('active')) {
        state[chip.dataset.group] = chip.dataset.value;
      }
      chip.addEventListener('click', () => {
        const group = chip.dataset.group;
        const value = chip.dataset.value;
        const isActive = chip.classList.contains('active');
        chips.filter(c => c.dataset.group === group).forEach(c => c.classList.remove('active'));
        if (!isActive) {
          chip.classList.add('active');
          state[group] = value;
        } else {
          state[group] = null;
        }
        filterCards();
      });
    });

    // -------- モーダル ----------
    const modal = document.getElementById('message-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalSubtitle = document.getElementById('modal-subtitle');
    const modalCancel = document.getElementById('modal-cancel');
    const form = document.getElementById('message-form');
    let lastFocused;

    function openModal(teacherName) {
      modalTitle.textContent = `${teacherName} にメッセージ`;
      modalSubtitle.textContent = `${teacherName} へ初回メッセージを送信します。返信はメールで届きます。`;
      modal.hidden = false;
      lastFocused = document.activeElement;
      form.reset();
      document.getElementById('student-name').focus();
    }

    function closeModal() {
      modal.hidden = true;
      if (lastFocused && typeof lastFocused.focus === 'function') {
        lastFocused.focus();
      }
    }

    function attachMessageButtons() {
      document.querySelectorAll('.message-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = btn.dataset.teacher || '先生';
          openModal(name);
        });
      });
    }

    modalCancel.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (!modal.hidden && e.key === 'Escape') {
        closeModal();
      }
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      alert('メッセージを送信しました！\n※デモ用のため実際の送信は行われません。');
      closeModal();
    });

    // 初期化
    loadTutors();
  </script>
</body>
</html>
